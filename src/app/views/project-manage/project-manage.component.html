<!-- <p>details works! {{ projectId }}</p> -->

<header class="font-bold mt-5 mx-auto max-w-7xl px-8 grid md:grid-cols-1">
  <h1 class="text-3xl text-black pb-4">Project Working with Tailwind CSS</h1>
  <hr />
  <p class="text-xl flex items-center">แก้ไขโครงการ 2024</p>
</header>

<div class="form-content p-3">

  <!-- Forms Manage Project -->
  <table mat-table cellspacing="0" class="mx-auto">
    <caption>เพิ่มโครงการและรายการกิจกรรมต่างๆ</caption>
    <tr>
      <td>
        <mat-form-field appearance="fill">
          <mat-label>Project Name</mat-label>
          <input matInput [(ngModel)]="project.name" placeholder="Name" req>
        </mat-form-field>
      </td>
      <td>
        <mat-form-field>
          <mat-label>Company ID</mat-label>
          <input matInput disabled value={{project.id}}>
        </mat-form-field>
      </td>
    </tr>

    <tr>
      <td>
        <mat-form-field appearance="fill">
          <mat-label>Start Date</mat-label>
          <input matInput [(ngModel)]="project.startDate" type="date">
        </mat-form-field>
      </td>
      <td>
        <mat-form-field appearance="fill">
          <mat-label>End Date</mat-label>
          <input matInput [(ngModel)]="project.endDate" type="date">
        </mat-form-field>
      </td>
    </tr>

    <tr>
      <td colspan="2">
        <mat-form-field class="w-full">
          <mat-label>Upload</mat-label>
          <button mat-icon-button matPrefix (click)="f_input.click()"><mat-icon>attach_file</mat-icon></button>
          <input readonly matInput #name="ngModel" [(ngModel)]="file_name" name="file" placeholder="Files or Project">
          <input type="file" multiple #f_input hidden (change)="uploading($event)" required />
          <mat-hint align="end">files {{this.file.length}}/5</mat-hint>
          @if (name.errors?.['required']) {
          <mat-error>Upload File is <strong>required</strong></mat-error>
          }
        </mat-form-field>
      </td>
    </tr>

    @if(this.file.length > 0) {
    <strong>Files to Upload</strong>
    <tr *ngFor="let f of file, let i = index">
      <td colspan="2">
        <mat-list>
          <mat-list-item>
            {{i + 1}}.&nbsp;{{f.name}}
          </mat-list-item>
          <mat-divider></mat-divider>
        </mat-list>
      </td>
    </tr>
    }
    @if(showFiles.length > 0) {
    <br>
    <strong>Click to Download File</strong>
    <tr *ngFor="let f of showFiles, let i = index">
      <td colspan="2">
        <mat-list>
          <mat-list-item>
            {{i + 1}}.
            &nbsp;
            <a [href]="show_url" target="_blank" download class="text-blue-400 hover:text-blue-700">{{f.fileName}}</a>
            &nbsp;
            <button type="button" (click)="onIsDelete(f.id)" mat-button
              color="warn"><mat-icon>delete</mat-icon></button>
          </mat-list-item>
          <mat-divider></mat-divider>
        </mat-list>
      </td>
    </tr>
    }


    <tr>
      <td colspan="2">
        <mat-form-field appearance="fill">
          <mat-label>Add Activity</mat-label>
          <input matInput [(ngModel)]="newActivityName" placeholder="Main Activity">
        </mat-form-field>

        <!-- ฺ(Button) Add / Done -->
        @if(!newActivityName) {
        <button mat-icon-button (click)="toggleNewActivityField()" color="primary">
          <mat-icon>add_circle</mat-icon>
        </button>
        } @else {
        <button mat-icon-button (click)="addActivity()" style="color: green;">
          <mat-icon>check_circle</mat-icon>
        </button>
        }
      </td>
    </tr>
  </table>

  <!-- Table Activities -->
  @if (project.activities && project.activities.length > 0 ) {
  <h3 class="text-center mt-3">รายการกิจกรรม</h3>

  <table mat-table cellspacing="0" class="mx-auto">
    <!-- Main -->
    <!-- ใช้ ngTemplateOutlet เพื่อแสดงกิจกรรมหลัก โดยส่ง project.activities และระดับ (level) เริ่มต้นเป็น 1 -->
    <tr>
      <ng-container
        *ngTemplateOutlet="nestedActivities; context: { $implicit: project.activities, level: 1 }"></ng-container>
    </tr>

    <!-- Sub -->
    <!-- สร้างโครงสร้างของกิจกรรมที่สามารถซ้อนกันได้ #nestedActivities) เป็นเทมเพลตสำหรับกิจกรรมย่อย -->
    <ng-template #nestedActivities let-activities let-level="level">

      <ng-container *ngFor="let subActivity of activities; let idx = index">
        <tr *ngIf="subActivity.isDelete != true">
          @if (level === 1 && idx === 0) {
          <!-- First Activity -->
          <td>
            <mat-form-field>
              <input matInput [(ngModel)]=" subActivity.name" placeholder="Main Activity">
            </mat-form-field>
          </td>
          } @else {
          <!-- Sub Activity -->
          <td *ngFor="let i of [].constructor(level - 1)"></td>
          <td><mat-form-field>
              <input matInput [(ngModel)]=" subActivity.name" placeholder="Main Activity">
            </mat-form-field></td>
          }
          <td>
            <!-- Remove / Add -->
            <button mat-icon-button color="warn" (click)="removeSubActivity(subActivity)">
              <mat-icon>remove</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="addSubActivity(subActivity)">
              <mat-icon>add</mat-icon>
            </button>
          </td>
        </tr>
        <!-- Sub Sub -->
        @if (subActivity.inverseActivityHeader && subActivity.inverseActivityHeader.length > 0) {
        <ng-container
          *ngTemplateOutlet="nestedActivities; context: { $implicit: subActivity.inverseActivityHeader, level: level + 1 }"></ng-container>
        }
      </ng-container>

    </ng-template>
  </table>
  }

  <!-- Cancel / Submit Buttons -->
  <div class="flex justify-center mt-4 mb-5">
    <button mat-button [routerLink]="['/project']">Back</button>
    &nbsp;
    <button mat-flat-button color="primary" cdkFocusInitial (click)="onSubmit()">Submit</button>
  </div>
</div>

<br>